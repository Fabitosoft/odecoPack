{% extends 'base.html' %}
{% load humanize %}
{% load crispy_forms_tags %}
{% block content %}
    <h1>Detalles Cliente
        <small>{{ object.nombre|title }} </small>
    </h1>
    <div class="row">
        <div class="col-md-12">
            <h3>Información General</h3>
            <hr>
            <p>
                <span class="label">Nit:</span> {{ object.nit }}
            </p>
            <p>
                <span class="label">Fecha Creación: </span> {{ object.fecha_creacion }}
            </p>
            {% if object.competencia %}
                <p>
                    <span class="label">Competencia: </span> <i class="fa fa-check-circle" aria-hidden="true"></i>
                </p>
            {% endif %}
            {% if object.cerro %}
                <p>
                    <span class="label">Esta Cerrado: </span>
                    <i class="fa fa-check-circle" aria-hidden="true"></i>

                </p>
            {% endif %}
            {% if object.industria %}
                <p>
                    <span class="label">Indústria: </span>
                    {{ object.industria.nombre }}
                </p>
            {% endif %}
            {% if object.clasificacion %}
                <p>
                    <span class="label">Clasificación: </span>
                    {{ object.clasificacion }}
                </p>
            {% endif %}
            {% if object.canal %}
                <p>
                    <span class="label">Canal: </span>
                    {{ object.canal.canal }}
                </p>
            {% endif %}


            {% if object.grupo %}
                <div>
                    <p>
                        <span class="label">Empresas Grupo:</span>{{ object.grupo }}
                    </p>
                    <ul>
                        {% for empresa in object.grupo.mis_empresas.all %}
                            {% if empresa.nit != object.nit %}
                                <li>
                                    <a href="{{ empresa.get_absolute_url }}">{{ empresa.nombre }}
                                        - {{ empresa.nit }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

        </div>

        {% with compras_list=object.mis_compras.all|dictsortreversed:"fecha_documento"|slice:":20" %}
            {% with cotizaciones_list=object.mis_cotizaciones.all|dictsortreversed:"fecha_envio"|slice:":20" %}
                {% with despachos_lista=object.mis_despachos.all|dictsortreversed:"fecha_envio"|slice:":20" %}
                    {% with sucursales_lista=object.mis_sucursales.all %}
                        <!-- Nav tabs -->
                        <ul class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active"><a href="#compras" aria-controls="compras" role="tab"
                                                                      data-toggle="tab">Ultimas 20 Compras</a></li>
                            {% if cotizaciones_list %}
                                <li role="presentation"><a href="#cotizaciones" aria-controls="cotizaciones" role="tab"
                                                           data-toggle="tab">Ultimas 20 Cotizaciones</a></li>
                            {% endif %}

                            {% if despachos_lista %}
                                <li role="presentation"><a href="#despachos" aria-controls="despachos" role="tab"
                                                           data-toggle="tab">Ultimos 20 Despachos</a></li>
                            {% endif %}

                            {% if sucursales_lista %}
                                <li role="presentation"><a href="#contactos" aria-controls="contactos" role="tab"
                                                           data-toggle="tab">Contactos</a></li>
                            {% endif %}

                        </ul>
                        <!-- Tab panes -->
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane active" id="compras">
                                <div class="row">
                                    <div class="col-md-12">

                                        {% if compras_list %}
                                            <table class="table table-bordered table-striped">
                                                <thead>
                                                <tr>
                                                    <th>
                                                        Nro.
                                                    </th>
                                                    <th>
                                                        Estado
                                                    </th>
                                                    <th>
                                                        Fecha
                                                    </th>
                                                    <th>
                                                        Departamento
                                                    </th>
                                                    <th>
                                                        Ciudad
                                                    </th>
                                                    <th>
                                                        Dirección
                                                    </th>
                                                    <th>
                                                        Vendedor
                                                    </th>
                                                    <th>
                                                        Vlr. Bruto
                                                    </th>
                                                    <th>
                                                        Descuentos
                                                    </th>
                                                    {% if perms.biable.ver_info_admon_ventas %}
                                                        <th>
                                                            Costo
                                                        </th>
                                                        <th>
                                                            Rentabilidad
                                                        </th>
                                                    {% endif %}
                                                    <th>
                                                        Vlr. Neto
                                                    </th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for compra in compras_list %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ compra.get_absolute_url }}">{{ compra.tipo_documento }}-{{ compra.nro_documento }}</a>
                                                        </td>
                                                        <td>
                                                            {% if compra.activa %}
                                                                <i class="fa fa-check-circle" aria-hidden="true"></i>
                                                            {% else %}
                                                                <i class="fa fa-times-circle" aria-hidden="true"></i>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {{ compra.fecha_documento }}
                                                        </td>
                                                        <td>
                                                            {{ compra.ciudad_biable.ciudad_intranet.departamento.nombre }}
                                                        </td>
                                                        <td>
                                                            {{ compra.ciudad_biable.ciudad_intranet.nombre }}
                                                        </td>
                                                        <td>
                                                            {{ compra.direccion_despacho }}
                                                        </td>
                                                        <td>
                                                            {{ compra.vendedor.nombre|title }}
                                                        </td>
                                                        <td>
                                                            {{ compra.venta_bruta|floatformat:2 }}
                                                        </td>
                                                        <td>
                                                            {{ compra.dscto_netos|floatformat:2 }}
                                                        </td>
                                                        {% if perms.biable.ver_info_admon_ventas %}
                                                            <td>
                                                                {{ compra.costo_total|floatformat:2 }}
                                                            </td>
                                                            <td>
                                                                {{ compra.rentabilidad|floatformat:2 }}
                                                            </td>
                                                        {% endif %}
                                                        <td>
                                                            {{ compra.venta_neto|floatformat:2 }}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        {% endif %}

                                    </div>
                                </div>
                            </div>
                            {% if cotizaciones_list %}
                                <div role="tabpanel" class="tab-pane" id="cotizaciones">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <table class="table table-bordered table-striped">
                                                <thead>
                                                <tr>
                                                    <th>
                                                        Nro.
                                                    </th>
                                                    <th>
                                                        Fecha Env.
                                                    </th>
                                                    <th>

                                                    </th>
                                                    <th>
                                                        Razón S.
                                                    </th>
                                                    <th>
                                                        Ciudad
                                                    </th>
                                                    <th>
                                                        Vendedor
                                                    </th>
                                                    <th>
                                                        Estado
                                                    </th>
                                                    <th>
                                                        Versión
                                                    </th>
                                                    <th>
                                                        Contacto
                                                    </th>
                                                    <th>
                                                        Nro. Contacto
                                                    </th>
                                                    <th>
                                                        Email
                                                    </th>
                                                    <th>
                                                        Total
                                                    </th>
                                                    <th>
                                                        Facturas Relacionadas
                                                    </th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% for cotizacion in cotizaciones_list %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ cotizacion.get_absolute_url }}">{{ cotizacion.nro_cotizacion }}</a>
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.fecha_envio }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.fecha_envio|naturaltime|capfirst }}
                                                        </td>
                                                        <td>
                                                            {% if cotizacion.cliente_nuevo %}
                                                                {{ cotizacion.razon_social }}
                                                            {% else %}
                                                                <a href="{{ cotizacion.cliente_biable.get_absolute_url }}"
                                                                   target="_blank">{{ cotizacion.cliente_biable.nombre }}</a>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if cotizacion.otra_ciudad %}
                                                                {{ cotizacion.pais|title }} -
                                                                {{ cotizacion.ciudad|title }}
                                                            {% else %}
                                                                {{ cotizacion.ciudad_despacho.nombre|title }} -
                                                                {{ cotizacion.ciudad_despacho.departamento.nombre|title }}
                                                                -
                                                                {{ cotizacion.ciudad_despacho.departamento.pais.nombre|title }}
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.usuario }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.get_estado_display }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.version }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.nombres_contacto }} {{ cotizacion.apellidos_contacto }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.nro_contacto }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.email }}
                                                        </td>
                                                        <td>
                                                            {{ cotizacion.total }}
                                                        </td>
                                                        {% with remisiones_list=cotizacion.mis_remisiones.all %}
                                                            {% if remisiones_list %}
                                                                <td>
                                                                    {% for remision in remisiones_list %}
                                                                        {% if remision.factura_biable %}
                                                                            <a href="{{ remision.factura_biable.get_absolute_url }}"
                                                                               target="popup"
                                                                               onclick="window.open('{{ remision.factura_biable.get_absolute_url }}','popup','width=600,height=600'); return false;">
                                                                                {{ remision.factura_biable.tipo_documento }}-{{ remision.factura_biable.nro_documento }}
                                                                            </a>
                                                                        {% endif %}
                                                                        -
                                                                    {% endfor %}
                                                                </td>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </tr>
                                                {% empty %}
                                                    <li>Ninguna Cotización</li>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% if despachos_lista %}
                                <div role="tabpanel" class="tab-pane" id="despachos">
                                    <div class="row">
                                        <div class="col-md-12">
                                            {% include 'despachos_mercancias/components/enviosTCC_table.html' with lista_envio=despachos_lista %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% if sucursales_lista %}
                                <div role="tabpanel" class="tab-pane" id="contactos">
                                    <div class="row">
                                        <div class="col-md-12" style="padding: 2em">
                                            <a href="{% url 'contactos:crear_contacto_empresa' nit=object.nit %}"><i
                                                    class="fa fa-plus  fa-2x"
                                                    aria-hidden="true">
                                                Nuevo</i></a>
                                        </div>
                                        <div class="col-md-12">
                                            {% for sucursal in sucursales_lista %}
                                                {% include 'biable/contacto_empresa_tabla.html' %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endwith %}
                {% endwith %}
            {% endwith %}
        {% endwith %}
    </div>
{% endblock %}
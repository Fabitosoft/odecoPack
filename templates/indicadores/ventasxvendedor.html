{% extends 'indicadores/base_indicadores.html' %}
{% load l10n %}

{% block title %}
    Vent x Vend
{% endblock %}

{% block titulo_indicador %}
    Ventas por Vendedor
{% endblock %}
{% block indicador_contenido %}
    <form method="get" id="boton2">
        <div class="form-group">
            <div class="row">
                <div class="col-sx-12 col-sm-4 col-md-3">
                    <label>Mes</label>
                    <select name="mes" class="form-control" multiple="multiple">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="col-sx-12 col-sm-4 col-md-3">
                    <label>Año</label>
                    <select name="ano" class="form-control">
                        {% localize off %}
                            {% for ano in anos_list %}
                                <option value="{{ ano }}">{{ ano }}</option>
                            {% endfor %}
                        {% endlocalize %}
                    </select>
                    <br>
                    <button type="submit" class="btn btn-primary">Consultar</button>
                </div>
            </div>
        </div>
    </form>
    <div>
        <div class="row">
            <div class="col-xs-12 col-sm-1">
                <h3>Año:
                    <small>{{ ano_filtro }}</small>
                </h3>
            </div>
            <div class="col-xs-12 col-sm-6">
                <h3>Meses:
                    <small>{{ meses_filtro }}</small>
                </h3>
            </div>
        </div>
    </div>
    <div id="tabla_pv"></div>
{% endblock %}

<script>
    {% block script %}

        $('#boton2').submit(function (e) {
            e.preventDefault()
            var target = e.target;
            var parent = target.parentElement;//parent of "target"
            var opciones = target['mes'].selectedOptions
            var meses = $.map(opciones, function (val, i) {
                return parseInt(val.value)
            });
            evento(target['ano'].value, meses)
        })

        function evento(ano, meses) {
            $.ajaxSetup({
                headers: {"X-CSRFToken": getCookie("csrftoken")}
            });
            var data = {
                'ano': ano,
                'meses': meses
            };
            $.post(".", data, function (data) {
                // pivot grid options
                $('#tabla_pv').empty()
                $('#tabla_pv').append('<div id =\'pgrid\'></div>')
                var config = {
                    dataSource: data,
                    dataHeadersLocation: 'columns',
                    canMoveFields: true,
                    theme: 'blue',
                    toolbar: {
                        visible: true
                    },
                    grandTotal: {
                        rowsvisible: true,
                        columnsvisible: true
                    },
                    subTotal: {
                        visible: true,
                        collapsed: true
                    },
                    fields: [
                        {name: 'vendedor_nombre', caption: 'Vendedor'},
                        {
                            name: 'v_bruta', caption: 'Valor Bruto',
                            dataSettings: {
                                aggregateFunc: 'sum',
                                formatFunc: function (value) {
                                    return value ? '$' + Number(value).formatMoney(0, ',', '.') : '';
                                }
                            }
                        },
                        {
                            name: 'Costo', caption: 'Costo',
                            dataSettings: {
                                aggregateFunc: 'sum',
                                formatFunc: function (value) {
                                    return value ? '$' + Number(value).formatMoney(0, ',', '.') : '';
                                }
                            }
                        },
                        {
                            name: 'v_neto', caption: 'Valor Neto',
                            dataSettings: {
                                aggregateFunc: 'sum',
                                formatFunc: function (value) {
                                    return value ? '$' + Number(value).formatMoney(0, ',', '.') : '';
                                }
                            }
                        },
                        {
                            name: 'renta', caption: 'Rentabilidad',
                            dataSettings: {
                                aggregateFunc: 'sum',
                                formatFunc: function (value) {
                                    return value ? '$' + Number(value).formatMoney(0, ',', '.') : '';
                                }
                            }
                        },
                        {
                            name: 'Descuentos', caption: 'Descuentos',
                            dataSettings: {
                                aggregateFunc: 'sum',
                                formatFunc: function (value) {
                                    return value ? '$' + Number(value).formatMoney(0, ',', '.') : '';
                                }
                            }
                        }
                    ],
                    rows: ['vendedor_nombre'],
                    columns: [],
                    data: ['v_bruta','Descuentos','v_neto','Costo','renta']
                };

                // instantiate and show the pivot grid
                new orb.pgridwidget(config).render(document.getElementById('pgrid'));
            });
        }

    {% endblock %}
</script>

{% block javascrip_external_sources %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.12.2/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/orb/1.0.9/orb.min.js"></script>
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/orb/1.0.9/orb.min.css">
{% endblock %}
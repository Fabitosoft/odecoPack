{% extends "cotizaciones/base_cotizacion.html" %}
{% load funciones_especiales %}
{% load crispy_forms_tags %}
{% load static %}

{% block titulo_pagina %}
    Cotizador {% if actual_cotizacion %}{{ actual_cotizacion.nro_cotizacion }}{% endif %}
{% endblock %}

{% block content_page %}
    <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    {% crispy form %}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Atención!: {% endif %}
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <form style='display:inline; ' action="{% url 'cotizaciones:cotizador' %}" method="post">
        {% csrf_token %}
        <button name="nueva_cotizacion" value="nueva" class="btn btn-danger" class="btn btn-primary" type="submit">
            <i class="fa fa-plus fa-2x" aria-hidden="true"></i>
        </button>
    </form>

    {% with cotizaciones_activas_list=cotizaciones_activas.all %}
        {% if cotizaciones_activas_list %}
            {% for cotizacion in cotizaciones_activas_list %}
                <form style='display:inline; ' action="{% url 'cotizaciones:cotizador' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="id_a_editar" value="{{ cotizacion.id }}"/>
                    <button {% if actual_cotizacion.id|floatformat == cotizacion.id|floatformat %}class="btn btn-danger"
                            {% else %}class="btn btn-primary"{% endif %}
                            type="submit">{{ cotizacion }}</button>
                </form>
            {% endfor %}
            <hr/>
        {% endif %}
    {% endwith %}
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
        {% if tab == "NUEVA" %}
            <li role="presentation" class="active"><a href="#nueva_cotizacion"
                                                      aria-controls="nueva_cotizacion"
                                                      role="tab"
                                                      data-toggle="tab">Nueva
                Cotizacion</a></li>
        {% endif %}
        {% if actual_cotizacion %}
            <li role="presentation" {% if tab == "COTIZACION" %} class="active"{% endif %}><a href="#cotizacion"
                                                                                              aria-controls="cotizacion"
                                                                                              role="tab"
                                                                                              data-toggle="tab">

                Detalle Cotización</a></li>
        {% endif %}
        <li role="presentation" {% if tab == "LISTA_PRECIOS" %} class="active"{% endif %}><a href="#lista_precios"
                                                                                             aria-controls="lista_precios"
                                                                                             role="tab"
                                                                                             data-toggle="tab">Lista
            de Precios</a></li>

    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane {% if tab == "LISTA_PRECIOS" %}active{% endif %}" id="lista_precios">
            <div class="row">
                <div class="col-md-12">
                    <div class="row">
{#                        {% crispy busqueda_producto_form %}#}
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <td>Referencia</td>
                                <td>Descripción</td>
                                <td>Cant. Emp.</td>
                                <td>Uni. Med.</td>
                                <td>Precio</td>
                            </tr>
                            </thead>
                            <tbody>
                            {% for pro in object_list_componentes %}
                                {% obtener_precio_lp pro.get_precio_base formas_pago_porcentaje as precio %}
                                <tr>
                                    <td>{{ pro.referencia }} </td>
                                    <td>{{ pro.descripcion_comercial|title }} </td>
                                    <td>{{ pro.cantidad_empaque }} </td>
                                    <td>{{ pro.unidad_medida.nombre|title }} </td>
                                    <td> {{ precio }} </td>
                                    {% if actual_cotizacion %}
                                        <td>
                                            <a href="{% url 'cotizaciones:add_item_cotizacion' item_id=pro.id precio=precio forma_pago=forma_de_pago cot_id=actual_cotizacion.id tipo=1 %}">
                                                +
                                            </a>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            {% for pro in object_list_articulos_catalogo %}
                                {% obtener_precio_lp pro.get_precio_base formas_pago_porcentaje as precio %}
                                <tr>
                                    <td>{{ pro.referencia }} </td>
                                    <td>{{ pro.nombre|title }} </td>
                                    <td></td>
                                    <td>{{ pro.unidad_medida|title }} </td>
                                    <td> {{ precio }} </td>
                                    {% if actual_cotizacion %}
                                        <td>
                                            <a href="{% url 'cotizaciones:add_item_cotizacion' item_id=pro.id precio=precio forma_pago=forma_de_pago cot_id=actual_cotizacion.id tipo=2 %}">
                                                +
                                            </a>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            {% for banda in object_list_bandas %}
                                {% obtener_precio_lp banda.get_precio_con_mano_obra formas_pago_porcentaje as precio %}
                                <tr>
                                    <td>{{ banda.referencia }} </td>
                                    <td>{{ banda.descripcion_comercial|title }} </td>
                                    <td> {{ banda.longitud }} </td>
                                    <td>Metro</td>
                                    <td> {{ precio }} </td>
                                    {% if actual_cotizacion %}
                                        <td>
                                            <a href="{% url 'cotizaciones:add_item_cotizacion' item_id=banda.id precio=precio forma_pago=forma_de_pago cot_id=actual_cotizacion.id tipo=3 %}">
                                                +
                                            </a>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% if actual_cotizacion %}
            <div role="tabpanel" class="tab-pane {% if tab == "COTIZACION" %}active{% endif %}" id="cotizacion">
                <div class="row">

                    <div class="col-md-9">
                        <table class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <td>Referencia</td>
                                <td>Nombre</td>
                                <td>Cantidad</td>
                                <td>Uni. Medida</td>
                                <td>Precio</td>
                                <td>Porcentaje Descuento %</td>
                                <td>Descuento $</td>
                                <td>Total</td>
                                <td>Días Ent.</td>
                            </tr>
                            </thead>
                            <tbody>
                            {% with item_coti_list=actual_cotizacion.items.all %}
                                {% if item_coti_list %}
                                    {% for item in item_coti_list %}
                                        <tr id="item-{{ item.id }}">
                                            <td>
                                                {{ item.get_referencia_item }}
                                            </td>
                                            <td>
                                                {{ item.get_nombre_item|title }}
                                            </td>
                                            <td>
                                                <input type='hidden' name='item' value='{{ item.id }}'/>
                                                <input class="item-qty" style="width: 60px" step=any
                                                       value="{{ item.cantidad|floatformat:2 }}"/>
                                            </td>
                                            <td>
                                                {{ item.get_unidad_item }}
                                            </td>
                                            <td>{{ item.precio }}</td>
                                            <td>
                                                <input type='hidden' name='item' value='{{ item.id }}'/>
                                                <input class="item-desc" style="width: 60px" step=any
                                                       value="{{ item.porcentaje_descuento|floatformat:2 }}"/>
                                            </td>
                                            <td class="descuento">{{ item.descuento }}</td>
                                            <td class="total">{{ item.total }}</td>
                                            <td>
                                                <input type='hidden' name='item' value='{{ item.id }}'/>
                                                <input type="number" pattern="[0-9]" class="item-ent"
                                                       style="width: 60px"
                                                       min="0" step="1"
                                                       value="{{ item.dias_entrega }}"/>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% endif %}
                            {% endwith %}
                            </tbody>
                            <tfoot>
                            <tr>
                                <td>
                                    Descuentos:
                                </td>
                                <td id="coti_val_descuento">
                                    {{ actual_cotizacion.descuento }}
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Total:
                                </td>
                                <td id="coti_val_total">
                                    {{ actual_cotizacion.total }}
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                        <div>
                            <h3>Adicionar Item Fuera de Lista</h3>
                            <hr>
{#                            {% crispy forma_item_otro %}#}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h3>Datos Cotización</h3>
                        <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
{#                        {% crispy cotizacion_form %}#}
                    </div>

                </div>
            </div>
        {% endif %}


        {% if tab == "NUEVA" %}
            <div role="tabpanel" class="tab-pane active" id="nueva_cotizacion">
                <div class="col-md-3">
                    <h3>Crear Nueva Cotización</h3>
                    <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
{#                    {% crispy cotizacion_nueva_form %}#}
                </div>
            </div>
        {% endif %}

    </div>
{% endblock %}

<script>
    {% block script %}
        $(".item-qty").change(function () {
            var item = $(this).prev("input[type='hidden']").val();
            var qty = $(this).val();
            var data = {
                item: item,
                qty: qty
            };
            $.get("{% url 'cotizaciones:add_qty_item_cotizacion' %}", data, function (data) {
                if (data.error_cantidad) {
                    alert("Digitar correctamente la cantidad para " + data.actual_item_error)
                }
                $("#coti_val_total").html(numberWithCommas(data.total_cotizacion));
                $("#coti_val_descuento").html(numberWithCommas(data.descuento_total));
                if (data.deleted) {
                    $("#item-" + item).fadeOut();
                }
                else {
                    $("#item-" + item).find('.total').html(numberWithCommas(data.total_line))
                    $("#item-" + item).find('.descuento').html(numberWithCommas(data.descuento))
                }
            });
        });
        $(".item-ent").change(function () {
            var item = $(this).prev("input[type='hidden']").val();
            var dias = $(this).val();
            var data = {
                item: item,
                dias: dias
            };
            $.get("{% url 'cotizaciones:cambiar_dias_item_cotizacion' %}", data, function (data) {
                console.log(data)
                if (data.error_cantidad) {
                    alert("Digitar correctamente los días de entrega para " + data.actual_item_error)
                }
            });
        });
        $(".item-desc").change(function () {
            var item = $(this).prev("input[type='hidden']").val();
            var desc = $(this).val();
            var data = {
                item: item,
                desc: desc
            };
            $.get("{% url 'cotizaciones:cambiar_descuento_item_cotizacion' %}", data, function (data) {
                if (data.error_porcentaje) {
                    alert(data.error_mensaje)
                }
                $("#item-" + item).find('.total').html(numberWithCommas(data.total_line))
                $("#item-" + item).find('.descuento').html(numberWithCommas(data.descuento))
                $("#coti_val_total").html(numberWithCommas(data.total_cotizacion));
                $("#coti_val_descuento").html(numberWithCommas(data.descuento_total));
            });
        });

        function numberWithCommas(x) {
            var parts = x.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            return parts.join(",");
        }

        if (!$('#id_cliente_nuevo').is(':checked')) {
            $("#div_id_razon_social").toggle(this.checked);
            $("#div_id_cliente_biable").toggle(!this.checked);
        } else {
            $("#div_id_razon_social").toggle(!this.checked);
            $("#div_id_cliente_biable").toggle(this.checked);
        }
        if (!$('#id_otra_ciudad').is(':checked')) {
            $("#div_id_pais").toggle(this.checked);
            $("#div_id_ciudad").toggle(this.checked);
            $("#div_id_ciudad_despacho").toggle(!this.checked);
        } else {
            $("#div_id_pais").toggle(!this.checked);
            $("#div_id_ciudad").toggle(!this.checked);
            $("#div_id_ciudad_despacho").toggle(this.checked);
        }

        $("#id_cliente_nuevo").change(function () {
            $("#div_id_razon_social").toggle(this.checked);
            $("#div_id_cliente_biable").toggle(!this.checked);
        });

        $("#id_otra_ciudad").change(function () {
            $("#div_id_pais").toggle(this.checked);
            $("#div_id_ciudad").toggle(this.checked);
            $("#div_id_ciudad_despacho").toggle(!this.checked);
        });
    {% endblock %}
</script>
